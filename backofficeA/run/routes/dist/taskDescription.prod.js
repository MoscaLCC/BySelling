"use strict";var express=require("express"),router=express.Router(),app=express();router.get("/:taskID",function(E,a,e){if(void 0===E.cookies.deploy)a.redirect("/");else if(void 0===E.cookies.online)a.redirect("/");else{var s=E.connection;s.query("SELECT COUNT(idMESSAGES) AS mg FROM ADMIN_MESSAGE WHERE Tipo=0 and IS_READ=1",function(e,o,r){E.app.locals.inbox=o[0].mg,s.query("SELECT COUNT(ID_ORDER) AS ord FROM ORDEM WHERE STATUS=0",function(e,o,r){E.app.locals.missedOrders=o[0].ord,s.query("SELECT COUNT(ID_TASK) AS tamanho FROM Task WHERE STATE=0",function(e,o,r){E.app.locals.missedMenu=o[0].tamanho,s.query("SELECT * FROM Task WHERE ID_TASK=?",E.params.taskID,function(e,o,r){var i=o;s.query("SELECT * FROM CLIENT INNER JOIN Task ON Task.Client_NIF=CLIENT.EMAIL WHERE ID_TASK=?",E.params.taskID,function(e,o,r){var n=o;s.query("SELECT * FROM ORDEM INNER JOIN Task ON Task.Ordem_ID=ORDEM.ID_ORDER WHERE ID_TASK=?",E.params.taskID,function(e,o,r){var s=o;a.render("taskDescription",{title:"Tasks",task:i,client:n,order:s,nome:E.cookies.nome})})})})})})})}}),router.put("/porra/:id",function(E,a){if(void 0===E.cookies.deploy)a.redirect("/");else if(void 0===E.cookies.online)a.redirect("/");else{var n=E.body.porra,i=E.connection;i.query("SELECT Client_NIF FROM Task WHERE ID_TASK=?",E.params.id,function(e,o,r){var s=o;"aceitar"==n&&i.query("UPDATE CLIENT SET IS_APPROVED=1 WHERE EMAIL=?",s[0].Client_NIF,function(e,o,r){i.query("UPDATE TASK SET STATE=1 WHERE ID_TASK=?",E.params.id,function(e,o,r){E.app.locals.missedMenu=E.app.locals.missedMenu-1,i.query("Select * from CLIENT WHERE EMAIL=?",s[0].Client_NIF,function(e,o,r){var s=o,n=E.transporter,i={from:E.cookies.email,to:s[0].EMAIL,subject:"Registo Uniline",text:"O seu registo no software de encomendas Uniline foi aprovado"};n.sendMail(i,function(e,o){e?(console.log(e),a.json({yo:"error"})):(console.log("Message sent: "+o.response),a.json({yo:o.response}))}),a.redirect("/tasks")})})}),"recusar"==n&&i.query("UPDATE CLIENT SET ID_BLOCKED=1 WHERE EMAIL=?",s[0].Client_NIF,function(e,o,r){i.query("UPDATE TASK SET STATE=1 WHERE ID_TASK=?",E.params.id,function(e,o,r){E.app.locals.missedMenu=E.app.locals.missedMenu-1,a.redirect("/tasks")})})})}}),router.put("/encomendas/:id",function(s,n){if(void 0===s.cookies.deploy)n.redirect("/");else if(void 0===s.cookies.online)n.redirect("/");else{var i=s.body.encomendas,E=s.connection;E.query("SELECT Ordem_ID FROM Task WHERE ID_TASK=?",s.params.id,function(e,o,r){ordem=o[0].Ordem_ID,"cancelar"==i&&E.query("UPDATE ORDEM SET STATUS=2 WHERE ID_ORDER=?",ordem,function(e,o,r){E.query("UPDATE TASK SET STATE=1 WHERE ID_TASK=?",s.params.id,function(e,o,r){s.app.locals.missedMenu=s.app.locals.missedMenu-1,n.redirect("/tasks")})})})}}),module.exports=router;