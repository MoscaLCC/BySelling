"use strict";var express=require("express"),router=express.Router(),Isemail=require("isemail"),app=express();router.get("/",function(s,n,e){if(void 0===s.cookies.deploy)n.redirect("/");else if(void 0===s.cookies.online)n.redirect("/");else{var r=s.connection;r.query("SELECT COUNT(idMESSAGES) AS mg FROM ADMIN_MESSAGE WHERE Tipo=0 and IS_READ=1",function(e,o,i){s.app.locals.inbox=o[0].mg,r.query("SELECT COUNT(ID_ORDER) AS ord FROM ORDEM WHERE STATUS=0",function(e,o,i){s.app.locals.missedOrders=o[0].ord,r.query("SELECT COUNT(ID_TASK) AS tamanho FROM Task WHERE STATE=0",function(e,o,i){s.app.locals.missedMenu=o[0].tamanho,n.render("compose",{title:"Compor",email:"example@email.com...",assunto:"Inserir assunto...",mensagem:"Inserir mensagem... ",mail:s.cookies.email,nome:s.cookies.nome})})})})}}),router.post("/",function(e,s,o){if(void 0===e.cookies.deploy)s.redirect("/");else if(void 0===e.cookies.online)s.redirect("/");else{var i=e.connection,n=e.transporter,r=e.body.email,a=e.body.assunto,t=e.body.mensagem;if(0==Isemail.validate(r))console.log(s.render("compose",{title:"Compor",status:"O email fornecido não é válido",email:r,assunto:a,mensagem:t,mail:e.cookies.email,nome:e.cookies.nome}));else{var m={from:e.cookies.email,to:r,subject:a,text:t};n.sendMail(m,function(e,o){e?(console.log(e),s.json({yo:"error"})):(console.log("Message sent: "+o.response),s.json({yo:o.response}))});var l=[a,t,r];i.query("INSERT INTO ADMIN_MESSAGE (SUBJECT, CONTENT, client_mail, Tipo, IS_READ, IS_FAVORITE, Data) VALUES (?,?, ?, 1,1,0,CURRENT_DATE)",l,function(e,o,i){s.redirect("/messages")})}}}),router.post("/clientInfo/:nif",function(e,o,i){void 0===e.cookies.deploy?o.redirect("/"):void 0===e.cookies.online?o.redirect("/"):o.render("compose",{title:"Compor",emailDefault:e.params.nif,assunto:"Inserir assunto...",mensagem:"Inserir mensagem...",mail:e.cookies.email,nome:e.cookies.nome})}),router.post("/clientInfo/bymail/:mail/:idmessage",function(s,n,e){if(void 0===s.cookies.deploy)n.redirect("/");else if(void 0===s.cookies.online)n.redirect("/");else{var r=s.connection;r.query("select IS_READ FROM ADMIN_MESSAGE WHERE idMESSAGES=?",s.params.idmessage,function(e,o,i){1==o[0].IS_READ?(s.app.locals.inbox--,r.query("UPDATE ADMIN_MESSAGE SET IS_READ=0 WHERE idMESSAGES=?",s.params.idmessage,function(e,o,i){n.render("compose",{title:"Compor",emailDefault:s.params.mail,assunto:"Inserir assunto...",mensagem:"Inserir mensagem...",mail:s.cookies.email,nome:s.cookies.nome})})):n.render("compose",{title:"Compor",emailDefault:s.params.mail,assunto:"Inserir assunto...",mensagem:"Inserir mensagem...",mail:s.cookies.email,nome:s.cookies.nome})})}}),router.post("/atualizar/:idtask",function(e,s,o){if(void 0===e.cookies.deploy)s.redirect("/");else if(void 0===e.cookies.online)s.redirect("/");else{e.connection.query("UPDATE TASK SET STATE=1 WHERE ID_TASK=?",e.params.idtask,function(e,o,i){s.redirect("/tasks")})}}),module.exports=router;