"use strict";var express=require("express"),bodyParser=require("body-parser"),router=express.Router(),cookieParser=require("cookie-parser"),formidable=require("formidable"),fs=require("fs");router.get("/",function(e,o,r){void 0===e.cookies.deploy?o.redirect("/"):void 0===e.cookies.online?o.redirect("/"):o.render("createProd",{title:"Novo Produto",mail:e.cookies.email,nome:e.cookies.nome})}),router.post("/",function(n,d,e){if(void 0===n.cookies.deploy)d.redirect("/");else if(void 0===n.cookies.online)d.redirect("/");else{(new formidable.IncomingForm).parse(n,function(e,u,o){console.log(JSON.stringify(u));var l=n.connection;n.connection;if(""!=o.foto1.name){var r=o.foto1.name.split(".");r=r[r.length-1],u.fotografia="prod_"+u.nameo+"."+r;try{curPath="./public/images/upload/prod_"+u.nameo+"."+r,fs.unlinkSync(curPath)}catch(e){console.log(e)}fs.rename(o.foto1.path,"./public/images/upload/"+u.fotografia,function(e){e?console.log("Ocorreram erros na gravação do ficheiro enviado"):console.log("Ficheiro recebido e guardado com sucesso")})}else u.fotografia="avatar.png";u.name=u.fname;var i="INSERT INTO `PRODUTO` (`NAME`, `DESCRIPTION`, `QUANTITY_PER_PACK`, `SIZE`, `FOTO`, `isActive`) VALUES('"+u.nameo+"','"+u.desc+"',0,'0','"+u.fotografia+"',1)";l.query(i,function(e,o,r){l.query("SELECT * FROM `PRODUTO`",function(e,o,r){for(var i=o[o.length-1].id_PRODUCT,n=!0,a=1,t=!0,s=1,c="";n;)null!=u["tams_"+a]?c=c+"INSERT INTO `size` (`size`, `produto`, `type`) VALUES ('"+u["tams_"+a]+"', "+i+", '0'); \n":n=!1,a++;for(;t;)null!=u["quants_"+s]?c=c+"INSERT INTO `size` (`size`, `produto`, `type`) VALUES ('"+u["quants_"+s]+"', "+i+", '1'); \n":t=!1,s++;console.log(c),l.query(c,function(e,o,r){d.redirect("/services")})})})})}}),module.exports=router;