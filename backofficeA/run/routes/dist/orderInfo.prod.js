"use strict";var express=require("express"),router=express.Router(),TreeMap=require("treemap-js"),formidable=require("formidable");router.get("/:orderID",function(a,t,e){new TreeMap,new TreeMap,new Array,new Array;if(void 0===a.cookies.deploy)t.redirect("/");else if(void 0===a.cookies.online)t.redirect("/");else{var c=a.connection;c.query("SELECT COUNT(idMESSAGES) AS mg FROM ADMIN_MESSAGE WHERE Tipo=0 and IS_READ=1",function(e,o,r){a.app.locals.inbox=o[0].mg,c.query("SELECT COUNT(ID_ORDER) AS ord FROM ORDEM WHERE STATUS=0",function(e,o,r){a.app.locals.missedOrders=o[0].ord,c.query("SELECT COUNT(ID_TASK) AS tamanho FROM Task WHERE STATE=0",function(e,o,r){a.app.locals.missedMenu=o[0].tamanho,c.query("SELECT * FROM ORDEM WHERE ID_ORDER=?",a.params.orderID,function(e,o,r){var s=o[0];c.query("SELECT * FROM ORDER_PRODUCT WHERE ID_ORDER=?",a.params.orderID,function(e,o,r){var i=o[0],n=o[0].id_PRODUCT;c.query("SELECT * FROM PRODUTO WHERE id_PRODUCT=?",n,function(e,o,r){var n=o[0];console.log(JSON.stringify(n)),t.render("orderInfo",{title:"Informação Encomenda",produt:n,ordprod:i,ordem:s,mail:a.cookies.email,nome:a.cookies.nome})})})})})})})}}),router.post("/exportar/:ordemID",function(a,t,e){if(void 0===a.cookies.deploy)t.redirect("/");else if(void 0===a.cookies.online)t.redirect("/");else{var n=a.connection;n.query("Select Client_NIF FROM ORDEM where ID_ORDER=?",a.params.ordemID,function(e,o,r){client_nif=o[0].Client_NIF,n.query("Select EMAIL FROM CLIENT where EMAIL=?",client_nif,function(e,o,r){var s=o[0].EMAIL;n.query("UPDATE ORDEM set STATUS = 1 where ID_ORDER=?",a.params.ordemID,function(e,o,r){var n=a.transporter,i={from:a.cookies.email,to:s,subject:"Encomenda Aprovada",text:"A sua encomenda foi aprovada"};n.sendMail(i,function(e,o){e?(console.log(e),t.json({yo:"error"})):(console.log("Message sent: "+o.response),t.json({yo:o.response}))}),t.redirect("/orderInfo/"+a.params.ordemID)})})})}}),router.put("/encomendas/:id",function(n,i){if(void 0===n.cookies.deploy)i.redirect("/");else if(void 0===n.cookies.online)i.redirect("/");else{var s=n.connection;s.query("SELECT ID_TASK FROM Task WHERE Ordem_ID=? and Tipo=1",n.params.id,function(e,o,r){task=o[0].ID_TASK,s.query("UPDATE ORDEM SET STATUS=2 WHERE ID_ORDER=?",n.params.id,function(e,o,r){s.query("UPDATE TASK SET STATE=1 WHERE ID_TASK=?",task,function(e,o,r){n.app.locals.missedMenu=n.app.locals.missedMenu-1,i.redirect("/tasks")})})})}}),router.post("/enviado/:ordemID",function(a,t,e){if(void 0===a.cookies.deploy)t.redirect("/");else if(void 0===a.cookies.online)t.redirect("/");else{var n=a.connection;n.query("Select Client_NIF FROM ORDEM where ID_ORDER=?",a.params.ordemID,function(e,o,r){client_nif=o[0].Client_NIF,n.query("Select EMAIL FROM CLIENT where EMAIL=?",client_nif,function(e,o,r){var s=o[0].EMAIL;n.query("UPDATE ORDEM set STATUS = 3 where ID_ORDER=?",a.params.ordemID,function(e,o,r){var n=a.transporter,i={from:a.cookies.email,to:s,subject:"Encomenda Enviada",text:"A sua encomenda foi enviada"};n.sendMail(i,function(e,o){e?(console.log(e),t.json({yo:"error"})):(console.log("Message sent: "+o.response),t.json({yo:o.response}))}),t.redirect("/orderInfo/"+a.params.ordemID)})})})}}),router.post("/finalizar/:ordemID",function(a,t,e){if(void 0===a.cookies.deploy)t.redirect("/");else if(void 0===a.cookies.online)t.redirect("/");else{var n=a.connection;n.query("Select Client_NIF FROM ORDEM where ID_ORDER=?",a.params.ordemID,function(e,o,r){client_nif=o[0].Client_NIF,n.query("Select EMAIL FROM CLIENT where EMAIL=?",client_nif,function(e,o,r){var s=o[0].EMAIL;n.query("UPDATE ORDEM set STATUS = 4 where ID_ORDER=?",a.params.ordemID,function(e,o,r){var n=a.transporter,i={from:a.cookies.email,to:s,subject:"Encomenda Finalizada",text:"A sua encomenda foi finalizada com sucesso!! Esperá-mos que tenha gostado dos nossos serviços"};n.sendMail(i,function(e,o){e?(console.log(e),t.json({yo:"error"})):(console.log("Message sent: "+o.response),t.json({yo:o.response}))}),t.redirect("/orderInfo/"+a.params.ordemID)})})})}}),router.post("/alterar/:ordemID",function(a,t,e){if(void 0===a.cookies.deploy)t.redirect("/");else if(void 0===a.cookies.online)t.redirect("/");else{var c=a.connection;(new formidable.IncomingForm).parse(a,function(e,i,o){c.query("Select Client_NIF FROM ORDEM where ID_ORDER=?",a.params.ordemID,function(e,o,r){client_nif=o[0].Client_NIF,c.query("Select EMAIL FROM CLIENT where EMAIL=?",client_nif,function(e,o,r){var s=o[0].EMAIL,n=i.size+"_"+i.quant;c.query("UPDATE ORDEM set TRACKING ='"+i.track+"', ASKED_DELIVERY_DATE ='"+i.dataentrega+"' where ID_ORDER="+a.params.ordemID,function(e,o,r){console.log(e),c.query("UPDATE ORDER_PRODUCT set opcao_valor ='"+n+"' where ID_ORDER="+a.params.ordemID,function(e,o,r){var n=a.transporter,i={from:a.cookies.email,to:s,subject:"Encomenda Actualizada",text:"A sua encomenda foi alterada com sucesso!! Consulte o site para ver as alterações."};n.sendMail(i,function(e,o){e?(console.log(e),t.json({yo:"error"})):(console.log("Message sent: "+o.response),t.json({yo:o.response}))}),t.redirect("/orderInfo/"+a.params.ordemID)})})})})})}}),module.exports=router;