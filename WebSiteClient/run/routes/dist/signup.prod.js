"use strict";var express=require("express"),router=express.Router(),bodyParser=require("body-parser"),user=require("../models/user"),formidable=require("formidable"),fs=require("fs");router.get("/",function(e,o,i){null==e.cookies.deploy?o.redirect("/indisponivel"):o.render("lr",{title:"Signup",NOME:e.cookies.nome,EMAIL:e.cookies.email,PHONE:e.cookies.phone,MORADA:e.cookies.address,SITE:e.cookies.site,FACE:e.cookies.face,TWITTER:e.cookies.twitter,NIF:e.cookies.nif})}),router.post("/",function(n,c,e){if(null==n.cookies.deploy)c.redirect("/indisponivel");else{var o=new formidable.IncomingForm,l="";o.parse(n,function(e,r,a){console.log(JSON.stringify(r));var t=n.connection;t.query('SELECT * FROM CLIENT WHERE EMAIL ="'+r.email+'"',function(e,o){if(e)console.log("Erro a adicionar utilizador: "+e),c.render("lr",{title:"Signup",status:"Ocorreu um erro, por favor tente novamente",NOME:n.cookies.nome,EMAIL:n.cookies.email,PHONE:n.cookies.phone,MORADA:n.cookies.address,SITE:n.cookies.site,FACE:n.cookies.face,TWITTER:n.cookies.twitter,NIF:n.cookies.nif});else if(0===o.length){console.log(r.pass),console.log(r.cpassword);if(r.pass!=r.cpassword)l="Erro na confirmação de password",c.render("lr",{title:"Signup",status:l,NOME:n.cookies.nome,EMAIL:n.cookies.email,PHONE:n.cookies.phone,MORADA:n.cookies.address,SITE:n.cookies.site,FACE:n.cookies.face,TWITTER:n.cookies.twitter,NIF:n.cookies.nif});else{if(""!=a.foto1.name){var i=a.foto1.name.split(".");i=i[i.length-1],r.fotografia=r.email.split("@")[0]+"."+i;try{curPath="./public/images/upload/"+r.email.split("@")[0]+"."+i,fs.unlinkSync(curPath)}catch(e){console.log(e)}fs.rename(a.foto1.path,"./public/images/upload/"+r.fotografia,function(e){e?(console.log("Ocorreram erros na gravação do ficheiro enviado"),console.log(e)):console.log("Ficheiro recebido e guardado com sucesso")})}else r.fotografia="avatar.png";r.name=r.fname;var s="INSERT INTO `CLIENT` (`NAME`, `NIF`, `EMAIL`, `PHONE`, `STREET`, `DOOR_NUMBER`, `CITY`, `COUNTRY`, `ZIP_CODE`, `PASS`, `IS_BLOCKED`, `img_path`, `IS_APPROVED`, `data_registo`) VALUES('"+r.name+"',"+r.nif+",'"+r.email+"','"+r.phone+"','"+r.rua+"',"+r.porta+",'"+r.city+"','"+r.country+"','"+r.zip+"','"+r.pass+"',0,'"+r.fotografia+"',0,CURDATE())";t.query(s,function(a,e,o){t.query("INSERT INTO Task (DESCRIPTION, STATE, Client_NIF, Tipo, dataPedido, Ordem_ID) VALUES('O cliente "+r.name+" pretende registar-se na aplicação',0,?,0,CURDATE(),null)",r.email,function(e,o,i){if(a)console.log("Erro ao efetuar o registo:\r\n"+a+"\r\n\r\n"),l=" Ocorreu um erro: "+a,c.render("lr",{title:"Signup",status:l,NOME:n.cookies.nome,EMAIL:n.cookies.email,PHONE:n.cookies.phone,MORADA:n.cookies.address,SITE:n.cookies.site,FACE:n.cookies.face,TWITTER:n.cookies.twitter,NIF:n.cookies.nif});else{var s=n.transporter,r={from:n.cookies.email,to:n.cookies.email,subject:"Nova Tarefa",text:"Possui uma nova tarefa relativa à aprovação de um registo"};s.sendMail(r,function(e,o){e?(console.log(e),c.json({yo:"error"})):(console.log("Message sent: "+o.response),c.json({yo:o.response}))}),l="Registo Efetuado com sucesso.",console.log("Registo Efetuado com sucesso"),c.redirect("/signin")}})})}}else c.render("lr",{title:"Signup",status:"Já existe um utilizador com esse nif",NOME:n.cookies.nome,EMAIL:n.cookies.email,PHONE:n.cookies.phone,MORADA:n.cookies.address,SITE:n.cookies.site,FACE:n.cookies.face,TWITTER:n.cookies.twitter,NIF:n.cookies.nif})})})}}),module.exports=router;