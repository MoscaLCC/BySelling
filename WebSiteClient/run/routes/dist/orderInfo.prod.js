"use strict";var express=require("express"),router=express.Router(),TreeMap=require("treemap-js");router.get("/:orderID",function(a,t,e){new TreeMap,new TreeMap,new Array,new Array;if(void 0===a.cookies.deploy)t.redirect("/");else if(void 0===a.cookies.onlineC)t.redirect("/");else{var E=a.connection;E.query("SELECT COUNT(idMESSAGES) AS mg FROM ADMIN_MESSAGE WHERE Tipo=0 and IS_READ=1",function(e,o,r){a.app.locals.inbox=o[0].mg,E.query("SELECT COUNT(ID_ORDER) AS ord FROM ORDEM WHERE STATUS=0",function(e,o,r){a.app.locals.missedOrders=o[0].ord,E.query("SELECT COUNT(ID_TASK) AS tamanho FROM Task WHERE STATE=0",function(e,o,r){a.app.locals.missedMenu=o[0].tamanho,E.query("SELECT * FROM ORDEM WHERE ID_ORDER=?",a.params.orderID,function(e,o,r){var s=o[0];E.query("SELECT * FROM ORDER_PRODUCT WHERE ID_ORDER=?",a.params.orderID,function(e,o,r){var i=o[0],n=i.id_PRODUCT;E.query("SELECT * FROM PRODUTO WHERE id_PRODUCT=?",n,function(e,o,r){var n=o[0];t.render("orderInfo",{title:"Informação Encomenda",ordprod:i,products:n,ordem:s,NOME:a.cookies.nome,EMAIL:a.cookies.email,PHONE:a.cookies.phone,MORADA:a.cookies.address,SITE:a.cookies.site,FACE:a.cookies.face,TWITTER:a.cookies.twitter,NIF:a.cookies.nif})})})})})})})}}),router.get("/finalizar/:ordemID",function(a,t,e){if(void 0===a.cookies.deploy)t.redirect("/");else if(void 0===a.cookies.online)t.redirect("/");else{var n=a.connection;n.query("Select Client_NIF FROM ORDEM where ID_ORDER=?",a.params.ordemID,function(e,o,r){client_nif=o[0].Client_NIF,n.query("Select EMAIL FROM CLIENT where EMAIL=?",client_nif,function(e,o,r){var s=o[0].EMAIL;n.query("UPDATE ORDEM set STATUS = 4 where ID_ORDER=?",a.params.ordemID,function(e,o,r){var n=a.transporter,i={from:a.cookies.email,to:s,subject:"Encomenda Finalizada",text:"A sua encomenda foi finalizada com sucesso!! Esperá-mos que tenha gostado dos nossos serviços"};n.sendMail(i,function(e,o){e?(console.log(e),t.json({yo:"error"})):(console.log("Message sent: "+o.response),t.json({yo:o.response}))}),t.redirect("/orderInfo/"+a.params.ordemID)})})})}}),module.exports=router;