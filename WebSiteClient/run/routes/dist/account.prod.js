"use strict";var express=require("express"),router=express.Router(),cookieParser=require("cookie-parser"),countries=require("../models/countries"),formidable=require("formidable"),fs=require("fs");router.get("/",function(i,r,e){if(null==i.cookies.deploy)r.redirect("/indisponivel");else if(void 0===i.cookies.onlineC)r.redirect("/signin");else{var o=i.cookies.onlineC;i.connection.query('SELECT * FROM CLIENT WHERE EMAIL ="'+o+'"',function(e,o){!e&&0<o.length&&r.render("account",{countries:countries,user:o[0],errors:!1,NAME:i.cookies.nome,EMAIL:i.cookies.email,PHONE:i.cookies.phone,MORADA:i.cookies.address,SITE:i.cookies.site,FACE:i.cookies.face,TWITTER:i.cookies.twitter,NIF:i.cookies.nif})})}}),router.post("/",function(c,t,e){if(null==c.cookies.deploy)t.redirect("/indisponivel");else if(void 0===c.cookies.onlineC)t.redirect("/signin");else{var o=new formidable.IncomingForm,a=c.cookies.onlineC;o.parse(c,function(e,i,o){if(""!=o.foto1.name){var r=o.foto1.name.split(".");if(r=r[r.length-1],i.fotografia=a+"."+r,"avatar.png"!=i.namefoto)try{curPath="./public/images/upload/"+a+"."+r,fs.unlinkSync(curPath)}catch(e){console.log(e)}fs.rename(o.foto1.path,"/images/upload/"+i.fotografia,function(e){e?console.log("Ocorreram erros na gravação do ficheiro enviado"):console.log("Ficheiro recebido e guardado com sucesso")})}else i.fotografia=i.namefoto;var n=c.connection,s="UPDATE CLIENT SET NAME='"+i.fname+"',NIF='"+i.nif+"',EMAIL='"+i.email+"',PHONE='"+i.phone+"',STREET='"+i.morada+"',COUNTRY='"+i.country+"',CITY='"+i.city+"',ZIP_CODE='"+i.codpost+"',img_path='"+i.fotografia+"' WHERE EMAIL='"+a+"'";console.log(s),n.query(s,function(e,o){e?t.redirect("/home"):i.nif!=a?t.redirect("/logout"):t.redirect("/home")})})}}),module.exports=router;